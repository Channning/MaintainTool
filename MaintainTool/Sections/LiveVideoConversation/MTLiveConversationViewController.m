
//
//  MTLiveConversationViewController.m
//  MaintainTool
//
//  Created by Channing_rong on 2018/12/13.
//  Copyright Â© 2018 Channing_rong. All rights reserved.
//

#import "MTLiveConversationViewController.h"
#import "AFNetworkReachabilityManager.h"
#import "TXLivePlayer.h"
#import <SocketRocket/SRWebSocket.h>
#import "MTCameraPlayerContainerView.h"
#import "MTCreateSessionApi.h"
#import "MTCloseSesstionApi.h"
#import <YLGIFImage.h>
#import <YLImageView.h>
#import "FeThreeDotGlow.h"
#import "WXApi.h"

#define kCharCount 6
#define kCameraContainerTopMargin 108

@interface MTLiveConversationViewController ()<TXLivePlayListener,SRWebSocketDelegate>
{
    
    
    BOOL isExistGuestLiveStream;
    
    NSTimer * heartBeat;
    NSTimeInterval reConnectTime;
    NSString *cameraStreamKey;
    NSString *phoneStreamKey;
}
@property (nonatomic,strong) MTCameraPlayerContainerView *cameraPlayerView;
@property (nonatomic,weak) IBOutlet UIView *topPlayerView;
@property (nonatomic,weak) IBOutlet UIView *bottomPlayerView;

@property (nonatomic,weak) IBOutlet UILabel *inviteLabel;
@property (nonatomic,weak) IBOutlet UIView *titleView;
@property (nonatomic,weak) IBOutlet UIButton *inviteButton;
@property (nonatomic,weak) IBOutlet UIButton *hangupButton;
@property (nonatomic,weak) IBOutlet UIButton *cameraVolumeButton;
@property (nonatomic,weak) IBOutlet YLImageView *gifImageView;
@property (nonatomic,weak) IBOutlet UIImageView *playerbgImageView;
@property (nonatomic,weak) IBOutlet UIView *controlView;
@property (nonatomic,weak) IBOutlet UIView *topVolumeView;

//@property (nonatomic,strong) TXLivePlayer * cameraLivePlayer;
@property (nonatomic,strong) TXLivePlayer * phoneLivePlayer;

@property (nonatomic,strong) SRWebSocket *socket;

@property (strong, nonatomic) FeThreeDotGlow *threeDot;
@end

@implementation MTLiveConversationViewController

- (void)viewDidLoad
{
    [super viewDidLoad];
    [self.view setFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT)];
    [self initNavgationItemSubviews];
    [self initCameraLivePlayer];
    [self setConstraintsForSubviews];
    [self initSRWebSocket];
    
    if (_guestRtmpLiveUrlString)
    {
        isExistGuestLiveStream = YES;
        [_cameraPlayerView.cameraLivePlayer setMute:YES];
        [self updateControlsStatusWith:YES];
        [UIView animateWithDuration:1 animations:^{
            [self updateViewConstraintsWith:YES];
        }];
        [self initPhoneLivePlayer];
    }
    else
    {
        [self generateSessionKey];
    }
    
    // Do any additional setup after loading the view.
}

-(void)viewWillAppear:(BOOL)animated
{
    [[UIApplication sharedApplication] setIdleTimerDisabled:YES];
    [super viewWillAppear:animated];
}

-(void)viewWillDisappear:(BOOL)animated
{
    
    [[UIApplication sharedApplication] setIdleTimerDisabled:NO];
    
    [_socket close];
    [_phoneLivePlayer stopPlay];
    [_phoneLivePlayer removeVideoWidget];
    
    [_cameraPlayerView.cameraLivePlayer stopPlay];
    [_cameraPlayerView.cameraLivePlayer removeVideoWidget];
    [super viewWillDisappear:animated];
}

-(void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    [_socket close];
    [_phoneLivePlayer stopPlay];
    [_phoneLivePlayer removeVideoWidget];
    
    [_cameraPlayerView.cameraLivePlayer stopPlay];
    [_cameraPlayerView.cameraLivePlayer removeVideoWidget];
#if !__has_feature(objc_arc)
    [super dealloc];
#endif
}

#pragma mark - updateViewConstraints
-(void)setConstraintsForSubviews
{
    float playerContrainerHeight = (SCREEN_HEIGHT-SafeAreaTopHeight)/2;
    float playerContrainerTop = IS_iPhoneX_Series ? 108 : 88;
    [self.cameraPlayerView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.left.and.right.equalTo(self.view);
         make.top.equalTo(self.view).offset(playerContrainerTop);
         make.height.mas_equalTo(playerContrainerHeight);
     }];
    
    float playerbgImageViewHeight = 256*SCREEN_WIDTH/375;
    [self.playerbgImageView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.centerY.equalTo(self->_cameraPlayerView);
         make.left.and.right.equalTo(self->_cameraPlayerView);
         make.height.mas_equalTo(playerbgImageViewHeight);
    }];
    
    [self.bottomPlayerView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.left.and.right.equalTo(self.view);
         make.top.equalTo(self.cameraPlayerView.mas_bottom);
         make.height.mas_equalTo(playerContrainerHeight);
     }];
    
    [self.titleView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.centerX.equalTo(self->_bottomPlayerView);
         make.top.equalTo(self->_bottomPlayerView).offset(40);
         make.height.mas_equalTo(26);
     }];
    
    [self.inviteLabel mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.left.equalTo(self->_titleView);
         make.right.equalTo(self->_titleView.mas_right).offset(26);
         make.top.and.bottom.equalTo(self->_titleView);
     }];
    
    [self.gifImageView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.left.equalTo(self->_inviteLabel.mas_right);
         make.centerY.equalTo(self->_titleView);
         make.width.mas_equalTo(20);
         make.height.mas_equalTo(15);
     }];
    [self.inviteButton mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.top.equalTo(self->_titleView.mas_bottom).offset(30);
         make.centerX.equalTo(self->_bottomPlayerView);
         make.width.mas_equalTo(166);
         make.height.mas_equalTo(36);
     }];
    
    [self.hangupButton mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.top.equalTo(self->_titleView.mas_bottom).offset(30);
         make.centerX.equalTo(self->_bottomPlayerView);
         make.width.mas_equalTo(110);
         make.height.mas_equalTo(35);
     }];
    
    [self.controlView mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.bottom.equalTo(self.view.mas_bottom).offset(-30);
         make.centerX.equalTo(self.view);
         make.width.mas_equalTo(180);
         make.height.mas_equalTo(70);
     }];
    
    float cameraVolumeY = playerContrainerTop+85;
    [self.cameraVolumeButton mas_makeConstraints:^(MASConstraintMaker *make)
     {
         make.right.equalTo(self.view.mas_right).offset(-30);
         make.top.equalTo(self.view.mas_top).offset(cameraVolumeY);
         make.width.mas_equalTo(40);
         make.height.mas_equalTo(40);
     }];
    
    
    
}

- (void)updateViewConstraintsWith:(BOOL)needUpdate
{
    if (needUpdate)
    {
        float topPlayerViewLeftX = SCREEN_WIDTH-240-10;
        float playerContrainerTop = IS_iPhoneX_Series ? 108 : 88;
        [self.cameraPlayerView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.right.equalTo(self.view.mas_right).offset(-20);
             make.left.equalTo(self.view.mas_left).offset(topPlayerViewLeftX);
             make.top.equalTo(self.view.mas_top).offset(playerContrainerTop);
             make.width.mas_equalTo(240);
             make.height.mas_equalTo(135);
         }];
        
        [self.playerbgImageView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.edges.mas_equalTo(UIEdgeInsetsMake(0, 0, 0, 0));
         }];
        
        [self.bottomPlayerView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.left.and.right.equalTo(self.view);
             make.top.equalTo(self.view.mas_top).offset(SafeAreaTopHeight);
             make.height.mas_equalTo(SCREEN_HEIGHT-SafeAreaTopHeight);
         }];
        
    }
    else
    {
        float playerContrainerHeight = (SCREEN_HEIGHT-SafeAreaTopHeight)/2;
        [self.cameraPlayerView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.left.and.right.equalTo(self.view);
             make.top.equalTo(self.view).offset(kCameraContainerTopMargin);
             make.height.mas_equalTo(playerContrainerHeight);
         }];
        
        float playerbgImageViewHeight = 256*SCREEN_WIDTH/375;
        [self.playerbgImageView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.centerY.equalTo(self->_cameraPlayerView);
             make.left.and.right.equalTo(self->_cameraPlayerView);
             make.height.mas_equalTo(playerbgImageViewHeight);
         }];
        float bottomPlayerViewY = SafeAreaTopHeight+playerContrainerHeight;
        [self.bottomPlayerView mas_updateConstraints:^(MASConstraintMaker *make)
         {
             make.left.and.right.equalTo(self.view);
             make.top.equalTo(self.view).offset(bottomPlayerViewY);
             make.height.mas_equalTo(playerContrainerHeight);
         }];
        
//        [self.titleView mas_updateConstraints:^(MASConstraintMaker *make)
//         {
//             make.centerX.equalTo(self->_bottomPlayerView);
//             make.top.equalTo(self->_bottomPlayerView).offset(40);
//             make.height.mas_equalTo(26);
//         }];
//
//        [self.inviteLabel mas_updateConstraints:^(MASConstraintMaker *make)
//         {
//             make.left.equalTo(self->_titleView);
//             make.right.equalTo(self->_titleView.mas_right).offset(26);
//             make.top.and.bottom.equalTo(self->_titleView);
//         }];
//
//        [self.gifImageView mas_updateConstraints:^(MASConstraintMaker *make)
//         {
//             make.left.equalTo(self->_inviteLabel.mas_right);
//             make.right.equalTo(self->_titleView.mas_right);
//             make.centerY.equalTo(self->_titleView);
//             make.width.mas_equalTo(20);
//             make.height.mas_equalTo(15);
//         }];
//        [self.inviteButton mas_updateConstraints:^(MASConstraintMaker *make)
//         {
//             make.top.equalTo(self->_titleView.mas_bottom).offset(30);
//             make.centerX.equalTo(self->_bottomPlayerView);
//             make.width.mas_equalTo(166);
//             make.height.mas_equalTo(36);
//         }];
//
//        [self.hangupButton mas_updateConstraints:^(MASConstraintMaker *make)
//         {
//             make.top.equalTo(self->_titleView.mas_bottom).offset(30);
//             make.centerX.equalTo(self->_bottomPlayerView);
//             make.width.mas_equalTo(110);
//             make.height.mas_equalTo(35);
//         }];
        
  
    }

}
#pragma mark - Init

- (void)initNavgationItemSubviews
{
    
    self.navigationController.navigationBarHidden = NO;
    
    UIBarButtonItem * backButtonItem = [[UIBarButtonItem alloc] init];
    backButtonItem.tintColor = [UIColor whiteColor];
    self.navigationItem.backBarButtonItem = backButtonItem;
    
    self.navigationItem.title = MyLocal(@"è§é¢éè¯");
    
    self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(shareLiveTicketRespond:) name:INFORMLIVECONVERSATIONUPDATEUI object:nil];

    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(showAlertForCameraIsOffline:) name:INFORMLIVECONVERSATIONSHOWALERT object:nil];
}

-(void)initSRWebSocket
{
    self.socket = [[SRWebSocket alloc] initWithURLRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"wss://wx.driftlife.co?open_id=%@",[AppDelegateHelper readData:SavedOpenID]]]]];
    // å®ç°è¿ä¸ª SRWebSocketDelegate åè®®å
    self.socket.delegate = self;
    [self.socket open];    // open å°±æ¯ç´æ¥è¿æ¥äº
}

//å³é­è¿æ¥
- (void)SRWebSocketClose
{
    if (self->_socket)
    {
        [self->_socket close];
        self->_socket = nil;
        //æ­å¼è¿æ¥æ¶éæ¯å¿è·³
        [self destoryHeartBeat];
    }
}

-(void)initCameraLivePlayer
{
    float playerContrainerHeight = (SCREEN_HEIGHT-SafeAreaTopHeight)/2;
    _cameraPlayerView = [[MTCameraPlayerContainerView alloc] initWithFrame:CGRectMake(0, kCameraContainerTopMargin, SCREEN_WIDTH, playerContrainerHeight) PlayUrl:_rtmpLiveUrlString];
    [self.view insertSubview:_cameraPlayerView aboveSubview:_bottomPlayerView];
    
}


-(void)initPhoneLivePlayer
{
    
    _phoneLivePlayer = [[TXLivePlayer alloc] init];
    _phoneLivePlayer.delegate = self;
    [_phoneLivePlayer setupVideoWidget:CGRectMake(0, 0, 0, 0) containView:_bottomPlayerView insertIndex:1];
    
    TXLivePlayConfig* _config = [[TXLivePlayConfig alloc] init];
    //èªå¨æ¨¡å¼
    //    _config.bAutoAdjustCacheTime   = YES;
    //    _config.minAutoAdjustCacheTime = 1;
    //    _config.maxAutoAdjustCacheTime = 5;
    //æéæ¨¡å¼
    _config.bAutoAdjustCacheTime   = YES;
    _config.minAutoAdjustCacheTime = 0.3;
    _config.maxAutoAdjustCacheTime = 1;
    _config.enableAEC = YES;
    //æµçæ¨¡å¼
    //    _config.bAutoAdjustCacheTime   = NO;
    //    _config.minAutoAdjustCacheTime = 5;
    //    _config.maxAutoAdjustCacheTime = 5;
    
    [_phoneLivePlayer setConfig:_config];
    /**
     * è®¾ç½®ç»é¢çè£åªæ¨¡å¼
     * @param renderMode è£åª
     * @see TX_Enum_Type_RenderMode
     */
    [_phoneLivePlayer setRenderRotation:HOME_ORIENTATION_DOWN];
    /**
     * è®¾ç½®ç»é¢çæ¹å
     * @param rotation æ¹å
     * @see TX_Enum_Type_HomeOrientation
     */
    [_phoneLivePlayer setRenderMode:RENDER_MODE_FILL_SCREEN];
    //è®¾ç½®å®æä¹ååå¯å¨æ­æ¾
    [_phoneLivePlayer startPlay:_guestRtmpLiveUrlString type:PLAY_TYPE_LIVE_RTMP];
    
    _threeDot = [[FeThreeDotGlow alloc] initWithView:self.view blur:NO];
    [self.view addSubview:_threeDot];
    [_threeDot showWhileExecutingBlock:^{
        
    }];
  
}

- (void)generateSessionKey
{
    //è³2019-02-26èµ·éè¯·ç å³liveSessionKeyæ¹ä¸º6ä½éæºæ°å­
    _liveSessionKey = @"";
    for(int i=0; i < 6; i++)
    {
        _liveSessionKey = [_liveSessionKey stringByAppendingFormat:@"%i",(arc4random() % 9)];
    }
    
    DLog(@"éæºæ°: %@", _liveSessionKey);
    
    
    if (_liveSessionKey)
    {
        [self createLiveSession];
    }
}

-(void)createLiveSession
{
    MTCreateSessionApi *generalCmdApi = [[MTCreateSessionApi alloc] initWithKey:MTLiveApiKey openID:[AppDelegateHelper readData:SavedOpenID] roomID:_roomid sessionKey:_liveSessionKey];
    [generalCmdApi startWithCompletionBlockWithSuccess:^(__kindof YTKBaseRequest * _Nonnull request)
     {
         id obj = [NSJSONSerialization JSONObjectWithData:request.responseData options:0 error:NULL];
         NSNumber *status = obj[@"status"];
         DLog(@"regResponse is %@",request.responseString);
         if(status.intValue == 1)
         {
             //[self initSRWebSocket];
         }
     } failure:^(__kindof YTKBaseRequest * _Nonnull request) {
         DLog(@"failure!%@",request.responseObject);
     }];
    
}

#pragma mark - IBActions
-(IBAction)inviteWechatFriend:(UIButton *)sender
{
    if (!self->_liveSessionKey)
    {
        [self generateSessionKey];
    }
    //è³2019-02-26èµ·éè¯·ç æ¹ä¸º6ä½éæºæ°å­
    //NSString *inviteCode = [NSString stringWithFormat:@"%@&%@",_roomid,_liveSessionKey];

    UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil
                                                                   message:nil
                                                            preferredStyle:UIAlertControllerStyleActionSheet];
    
    [alert addAction:[UIAlertAction actionWithTitle:@"éè¯·å¾®ä¿¡å¥½å" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action)
                      
                      {
                        
                          
                          WXMiniProgramObject *object = [WXMiniProgramObject object];
                          object.webpageUrl = @"www.foream.com";
                          object.userName = @"gh_885fb1cdacb2";
                          object.path = [NSString stringWithFormat:@"/pages/livestart/playpush/playpush?room_id=%@&open_id=%@&session_key=%@&share_type=share_wechat",self->_roomid,[AppDelegateHelper readData:SavedOpenID],self->_liveSessionKey];
                          
                          object.hdImageData = UIImagePNGRepresentation([UIImage imageNamed:@"Live_Share_bg"]);
                          object.withShareTicket = YES;
                          
                          WXMediaMessage *message = [WXMediaMessage message];
                          message.title = [NSString stringWithFormat:@"%@%@",LastLoginUserId,@"éè¯·ä½ è¿è¡è§é¢éè¯"];
                          message.description = [NSString stringWithFormat:@"%@%@",LastLoginUserId,@"éè¯·ä½ è¿è¡è§é¢éè¯"];
                          message.thumbData = nil;  //å¼å®¹æ§çæ¬èç¹çå¾çï¼å°äº32KBï¼æ°çæ¬ä¼å
                          //ä½¿ç¨WXMiniProgramObjectçhdImageDataå±æ§
                          message.mediaObject = object;
                          
                          SendMessageToWXReq *req = [[SendMessageToWXReq alloc] init];
                          req.bText = NO;
                          req.message = message;
                          req.scene = WXSceneSession;  //ç®ååªæ¯æä¼è¯
                          [WXApi sendReq:req];
                      }]];
    
    [alert addAction:[UIAlertAction actionWithTitle:@"éè¯·PCç¨æ·" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action)
                      
                      {
                          WXMiniProgramObject *object = [WXMiniProgramObject object];
                          object.webpageUrl = @"www.foream.com";
                          object.userName = @"gh_885fb1cdacb2";
                          object.path = [NSString stringWithFormat:@"/pages/livestart/playpush/playpush?room_id=%@&open_id=%@&session_key=%@&share_type=share_pc",self->_roomid,[AppDelegateHelper readData:SavedOpenID],self->_liveSessionKey];
                          
                          object.hdImageData = UIImagePNGRepresentation([UIImage imageNamed:@"Live_Share_bg"]);
                          object.withShareTicket = YES;
                          
                          WXMediaMessage *message = [WXMediaMessage message];
                          message.title = [NSString stringWithFormat:@"%@%@",LastLoginUserId,@"éè¯·ä½ è¿è¡è§é¢éè¯"];
                          message.description = [NSString stringWithFormat:@"%@%@",LastLoginUserId,@"éè¯·ä½ è¿è¡è§é¢éè¯"];
                          message.thumbData = nil;  //å¼å®¹æ§çæ¬èç¹çå¾çï¼å°äº32KBï¼æ°çæ¬ä¼å
                          //ä½¿ç¨WXMiniProgramObjectçhdImageDataå±æ§
                          message.mediaObject = object;
                          
                          SendMessageToWXReq *req = [[SendMessageToWXReq alloc] init];
                          req.bText = NO;
                          req.message = message;
                          req.scene = WXSceneSession;  //ç®ååªæ¯æä¼è¯
                          [WXApi sendReq:req];
    
                      }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"åæ¶" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action)
                      
                      {
              
                      }]];
    
    [self presentViewController:alert animated:YES completion:nil];
    
    
 


}

-(IBAction)hangupLiveInvite:(UIButton *)sender
{
    self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";

    _gifImageView.hidden = YES;
    self.hangupButton.hidden = YES;
    self.inviteButton.hidden = NO;

    

}

-(IBAction)cameraVolumeButton:(UIButton *)sender
{
    sender.selected = !sender.selected;
    if (sender.selected)
    {
        [sender setBackgroundImage:[UIImage imageNamed:@"Conversation_volume_on"] forState:UIControlStateNormal];
        [_cameraPlayerView.cameraLivePlayer setMute:NO];
    }
    else
    {
        [sender setBackgroundImage:[UIImage imageNamed:@"Conversation_volume_off"] forState:UIControlStateNormal];
        [_cameraPlayerView.cameraLivePlayer setMute:YES];
        
    }
}

-(IBAction)phoneVolumeButton:(UIButton *)sender
{
    sender.selected = !sender.selected;
    if (sender.selected)
    {
        [sender setBackgroundImage:[UIImage imageNamed:@"Conversation_volume_off"] forState:UIControlStateNormal];
        [_phoneLivePlayer setMute:YES];
    
    }
    else
    {
        [sender setBackgroundImage:[UIImage imageNamed:@"Conversation_volume_on"] forState:UIControlStateNormal];
        [_phoneLivePlayer setMute:NO];
        
    }
}

-(IBAction)hangupButtonAction:(UIButton *)sender
{
    MTCloseSesstionApi *generalCmdApi = [[MTCloseSesstionApi alloc] initWithKey:MTLiveApiKey roomID:_roomid sessionKey:_liveSessionKey];
    [generalCmdApi startWithCompletionBlockWithSuccess:^(__kindof YTKBaseRequest * _Nonnull request)
     {
         id obj = [NSJSONSerialization JSONObjectWithData:request.responseData options:0 error:NULL];
         NSNumber *status = obj[@"status"];
         DLog(@"regResponse is %@",request.responseString);
         if(status.intValue == 1)
         {
             self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";
             
             self->_gifImageView.hidden = YES;
             self.hangupButton.hidden = YES;
             self.inviteButton.hidden = NO;
             self.inviteLabel.hidden = NO;
             self.controlView.hidden = YES;
             self.cameraVolumeButton.hidden = YES;
             [UIView animateWithDuration:1 animations:^
              {
                  [self.cameraPlayerView setFrame:CGRectMake(0, kCameraContainerTopMargin, SCREEN_WIDTH, (SCREEN_HEIGHT-SafeAreaTopHeight)/2)];
                  [self.bottomPlayerView setFrame:CGRectMake(0, SafeAreaTopHeight+(SCREEN_HEIGHT-SafeAreaTopHeight)/2, SCREEN_WIDTH, (SCREEN_HEIGHT-SafeAreaTopHeight)/2)];
                  //[self.cameraVolumeButton setFrame:CGRectMake(180, 85, 40,40)];
              } completion:^(BOOL finished)
              {
                  if (finished)
                  {
                 
                      [self->_phoneLivePlayer removeVideoWidget];
                      self->_liveSessionKey = nil;
                  }
              }];
         }
     } failure:^(__kindof YTKBaseRequest * _Nonnull request) {
         DLog(@"failure!%@",request.responseObject);
     }];
}


-(void)liveCloseSessionRequest
{
    if (_liveSessionKey)
    {
        MTCloseSesstionApi *generalCmdApi = [[MTCloseSesstionApi alloc] initWithKey:MTLiveApiKey roomID:_roomid sessionKey:_liveSessionKey];
        [generalCmdApi startWithCompletionBlockWithSuccess:^(__kindof YTKBaseRequest * _Nonnull request)
         {
             id obj = [NSJSONSerialization JSONObjectWithData:request.responseData options:0 error:NULL];
             NSNumber *status = obj[@"status"];
             DLog(@"regResponse is %@",request.responseString);
             if(status.intValue == 1)
             {
                 [self.navigationController popToRootViewControllerAnimated:YES];
             }
         } failure:^(__kindof YTKBaseRequest * _Nonnull request) {
             DLog(@"failure!%@",request.responseObject);
         }];
    }
 
}

-(void)shareLiveTicketRespond:(NSNotification *)resp
{
    self.inviteLabel.text = @"ç­å¾å¯¹æ¹è¿å¥...";
    
    _gifImageView.hidden = NO;
    _gifImageView.image = [YLGIFImage imageNamed:@"invite_loading.gif"];
    
    self.inviteButton.hidden = YES;
    self.hangupButton.hidden = NO;
}

-(void)showAlertForCameraIsOffline:(NSNotification *)resp
{
    __weak __typeof(self) weakSelf = self;
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"éè¯ä¸­æ­"
                                                                   message:@"ç¸æºå·²ç»ç¦»çº¿æèå³æº"
                                                            preferredStyle:UIAlertControllerStyleAlert];
    
    [alert addAction:[UIAlertAction actionWithTitle:@"ç¦»å¼" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action)
                      
                      {
                          [weakSelf liveCloseSessionRequest];
                      }]];
    [self presentViewController:alert animated:YES completion:nil];
}


-(void)updateControlsStatusWith:(BOOL)isExistGuestLive
{
    if (isExistGuestLive)
    {
        self.gifImageView.hidden = YES;
        self.hangupButton.hidden = YES;
        self.inviteButton.hidden = YES;
        self.inviteLabel.hidden = YES;
        self.playerbgImageView.hidden = YES;
        self.controlView.hidden = NO;
        self.cameraVolumeButton.hidden = NO;
    }
    else
    {
        self.gifImageView.hidden = YES;
        self.hangupButton.hidden = YES;
        self.inviteButton.hidden = NO;
        self.inviteLabel.hidden = NO;
        self.controlView.hidden = YES;
        self.cameraVolumeButton.hidden = YES;
    }

}

#pragma mark - SRWebSocketDelegate

- (void)webSocketDidOpen:(SRWebSocket *)webSocket
{
    NSLog(@"è¿æ¥æåï¼å¯ä»¥ç«å»ç»å½ä½ å¬å¸åå°çæå¡å¨äºï¼è¿æå¼å¯å¿è·³");
    //æ¯æ¬¡æ­£å¸¸è¿æ¥çæ¶åæ¸é¶éè¿æ¶é´
    reConnectTime = 0;
    //å¼å¯å¿è·³ å¿è·³æ¯åépongçæ¶æ¯ æè¿éæ ¹æ®åå°çè¦æ±åédataç»åå°
    [self initHeartBeat];
}

- (void)webSocket:(SRWebSocket *)webSocket didFailWithError:(NSError *)error
{
    NSLog(@"è¿æ¥å¤±è´¥ï¼è¿éå¯ä»¥å®ç°æçº¿èªå¨éè¿ï¼è¦æ³¨æä»¥ä¸å ç¹");
    NSLog(@"1.å¤æ­å½åç½ç»ç¯å¢ï¼å¦ææ­ç½äºå°±ä¸è¦è¿äºï¼ç­å¾ç½ç»å°æ¥ï¼å¨åèµ·éè¿");
    NSLog(@"2.å¤æ­è°ç¨å±æ¯å¦éè¦è¿æ¥ï¼ä¾å¦ç¨æ·é½æ²¡å¨èå¤©çé¢ï¼è¿æ¥ä¸å»æµªè´¹æµé");
    NSLog(@"3.è¿æ¥æ¬¡æ°éå¶ï¼å¦æè¿æ¥å¤±è´¥äºï¼éè¯10æ¬¡å·¦å³å°±å¯ä»¥äºï¼ä¸ç¶å°±æ­»å¾ªç¯äºãæèæ¯é1ï¼2ï¼4ï¼8ï¼10ï¼10ç§éè¿...f(x) = f(x-1) * 2, (x=5)");
    //è¿æ¥å¤±è´¥å°±éè¿
    [self reConnect];
    
}

- (void)webSocket:(SRWebSocket *)webSocket didCloseWithCode:(NSInteger)code reason:(NSString *)reason wasClean:(BOOL)wasClean
{
    NSLog(@"è¿æ¥æ­å¼ï¼æ¸ç©ºsocketå¯¹è±¡ï¼æ¸ç©ºè¯¥æ¸ç©ºçä¸è¥¿ï¼è¿æå³é­å¿è·³ï¼");
    //è¿æ¥å¤±è´¥å°±éè¿
    [self reConnect];
}

/*
 è¯¥å½æ°æ¯æ¥æ¶æå¡å¨åéçpongæ¶æ¯ï¼å¶ä¸­æåä¸ä¸ªæ¯æ¥åpongæ¶æ¯çï¼
 å¨è¿éå°±è¦æä¸ä¸å¿è·³åï¼ä¸è¬æåµä¸å»ºç«é¿è¿æ¥é½ä¼å»ºç«ä¸ä¸ªå¿è·³åï¼
 ç¨äºæ¯éä¸æ®µæ¶é´éç¥ä¸æ¬¡æå¡ç«¯ï¼å®¢æ·ç«¯è¿æ¯å¨çº¿ï¼è¿ä¸ªå¿è·³åå¶å®å°±æ¯ä¸ä¸ªpingæ¶æ¯ï¼
 æççè§£å°±æ¯å»ºç«ä¸ä¸ªå®æ¶å¨ï¼æ¯éåç§æèåäºç§åæå¡ç«¯åéä¸ä¸ªpingæ¶æ¯ï¼è¿ä¸ªæ¶æ¯å¯æ¯æ¯ç©ºç
 */
-(void)webSocket:(SRWebSocket *)webSocket didReceivePong:(NSData *)pongPayload
{
    
    NSString *reply = [[NSString alloc] initWithData:pongPayload encoding:NSUTF8StringEncoding];
    NSLog(@"reply===%@",reply);
}


- (void)webSocket:(SRWebSocket *)webSocket didReceiveMessage:(id)message
{
    
    NSData *data = [message dataUsingEncoding:NSUTF8StringEncoding];
    id obj = [NSJSONSerialization JSONObjectWithData:data options:0 error:NULL];
    NSDictionary *messageDic = obj;
    DLog(@"Received Message Is %@",messageDic);
    if ([messageDic[@"type"] isEqualToString:@"stream_status"])
    {
        NSDictionary *dataDic = messageDic[@"data"];
        if ([dataDic[@"stream_status"] intValue] == 2)
        {
            //æ¨æµä¸­
            
        }
        else if([dataDic[@"stream_status"] intValue] == 1)
        {
            if ([cameraStreamKey isEqualToString: dataDic[@"stream_key"]])
            {
                __weak __typeof(self) weakSelf = self;
                UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"éè¯ä¸­æ­"
                                                                               message:@"ç¸æºå·²ç»ç¦»çº¿æèå³æº"
                                                                        preferredStyle:UIAlertControllerStyleAlert];
                
                [alert addAction:[UIAlertAction actionWithTitle:@"ç¦»å¼" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action)
                                  
                                  {
                                      [weakSelf.navigationController popToRootViewControllerAnimated:YES];
                                  }]];
                [self presentViewController:alert animated:YES completion:nil];
            }
          
            self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";
            
            _gifImageView.hidden = YES;
            self.hangupButton.hidden = YES;
            self.inviteButton.hidden = NO;
        }
    }
    else if ([messageDic[@"type"] isEqualToString:@"join_session"])
    {
        NSDictionary *dataDic = messageDic[@"data"];
        NSDictionary *dataDic2 = dataDic[@"data"];
        NSDictionary *roomDic = dataDic2[@"room"];
        NSDictionary *guestStreamDic = roomDic[@"guest_stream"];
        NSDictionary *ownerStreamDic = roomDic[@"owner_stream"];
        self.roomid = roomDic[@"room_id"];
        self.guestRtmpLiveUrlString = guestStreamDic[@"rtmp"];
        self.guestFlvLiveUrlString = guestStreamDic[@"flv"];
        phoneStreamKey = guestStreamDic[@"stream_key"];
        cameraStreamKey = ownerStreamDic[@"stream_key"];
        
        
        DLog(@"guestRtmpLiveUrlString is %@, and self.roomid is %@",self.guestRtmpLiveUrlString,self.roomid);
        [self updateControlsStatusWith:YES];
        isExistGuestLiveStream = YES;
        
        [UIView animateWithDuration:1 animations:^{
            [self updateViewConstraintsWith:YES];
        }];
        if (!self.phoneLivePlayer)
        {
            [self initPhoneLivePlayer];
        }
        else
        {
            
            [self->_phoneLivePlayer removeVideoWidget];
            [self->_phoneLivePlayer setupVideoWidget:CGRectZero containView:self->_bottomPlayerView insertIndex:0];
            [self->_phoneLivePlayer startPlay:_guestRtmpLiveUrlString type:PLAY_TYPE_LIVE_RTMP];
            _threeDot = [[FeThreeDotGlow alloc] initWithView:self.view blur:NO];
            [self.view addSubview:_threeDot];
            [_threeDot showWhileExecutingBlock:^{

            }];
        }
        
        
    }
    else if ([messageDic[@"type"] isEqualToString:@"close_session"])
    {
        self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";
        
        [self updateControlsStatusWith:NO];
        isExistGuestLiveStream = NO;
        [_threeDot removeFromSuperview];
        _threeDot = nil;
        [UIView animateWithDuration:1 animations:^{
            [self updateViewConstraintsWith:NO];
        }];
        self->_liveSessionKey = nil;
        if (self.phoneLivePlayer)
        {
            [self->_phoneLivePlayer stopPlay];
            [self->_phoneLivePlayer removeVideoWidget];
        }
        
        
    }
    
}

#pragma mark - Privite Metheds

//éè¿æºå¶
- (void)reConnect
{
    [self SRWebSocketClose];
    //è¶è¿ä¸åéå°±ä¸åéè¿ æä»¥åªä¼éè¿5æ¬¡ 2^5 = 64
    if (reConnectTime > 64)
    {
        return;
    }
    
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(reConnectTime * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        self->_socket = nil;
        [self initSRWebSocket];
        NSLog(@"éè¿");
    });
    
    //éè¿æ¶é´2çææ°çº§å¢é¿
    if (reConnectTime == 0)
    {
        reConnectTime = 2;
    }else{
        reConnectTime *= 2;
    }
}

//åå§åå¿è·³
- (void)initHeartBeat
{
    [self destoryHeartBeat];
    __weak typeof(self) weakSelf = self;
    //å¿è·³è®¾ç½®ä¸º3åéï¼NATè¶æ¶ä¸è¬ä¸º5åé
    if (@available(iOS 10.0, *)) {
        self->heartBeat = [NSTimer scheduledTimerWithTimeInterval:3*60 repeats:YES block:^(NSTimer * _Nonnull timer) {
            NSLog(@"heart");
            //åæå¡ç«¯çº¦å®å¥½åéä»ä¹ä½ä¸ºå¿è·³æ è¯ï¼å°½å¯è½çåå°å¿è·³åå¤§å°
            [weakSelf ping];
        }];
    } else {
        // Fallback on earlier versions
    }
    [[NSRunLoop currentRunLoop]addTimer:self->heartBeat forMode:NSRunLoopCommonModes];
}

//åæ¶å¿è·³
- (void)destoryHeartBeat
{
    if (self->heartBeat)
    {
        [self->heartBeat invalidate];
        self->heartBeat = nil;
    }
}

//pingPongæºå¶
- (void)ping
{
    NSDictionary *dict =[NSDictionary dictionaryWithObject:@"ping" forKey:@"type"];
    [self->_socket sendPing:[NSJSONSerialization dataWithJSONObject:dict options:NSJSONWritingPrettyPrinted error:nil]];
}

- (void)sendData:(id)data
{
    
    __weak __typeof(&*self)weakSelf = self;
    dispatch_queue_t queue =  dispatch_queue_create("zy", NULL);
    
    dispatch_async(queue, ^{
        if (weakSelf.socket != nil) {
            // åªæ SR_OPEN å¼å¯ç¶ææè½è° send æ¹æ³ï¼ä¸ç¶è¦å´©
            if (weakSelf.socket.readyState == SR_OPEN) {
                [weakSelf.socket send:data];    // åéæ°æ®
                
            } else if (weakSelf.socket.readyState == SR_CONNECTING) {
                NSLog(@"æ­£å¨è¿æ¥ä¸­ï¼éè¿åå¶ä»æ¹æ³ä¼å»èªå¨åæ­¥æ°æ®");
                // æ¯é2ç§æ£æµä¸æ¬¡ socket.readyState ç¶æï¼æ£æµ 10 æ¬¡å·¦å³
                // åªè¦æä¸æ¬¡ç¶ææ¯ SR_OPEN çå°±è°ç¨ [ws.socket send:data] åéæ°æ®
                // å¦æ 10 æ¬¡é½è¿æ¯æ²¡è¿ä¸çï¼é£è¿ä¸ªåéè¯·æ±å°±ä¸¢å¤±äºï¼è¿ç§æåµæ¯æå¡å¨çé®é¢äºï¼å°æ¦çç
                [self reConnect];
                
            } else if (weakSelf.socket.readyState == SR_CLOSING || weakSelf.socket.readyState == SR_CLOSED) {
                // websocket æ­å¼äºï¼è°ç¨ reConnect æ¹æ³éè¿
                [self reConnect];
            }
        } else {
            NSLog(@"æ²¡ç½ç»ï¼åéå¤±è´¥ï¼ä¸æ¦æ­ç½ socket ä¼è¢«æè®¾ç½® nil ç");
        }
    });
}


#pragma mark - TXLivePlayListener

-(void) onPlayEvent:(int)EvtID withParam:(NSDictionary*)param
{
    NSDictionary* dict = param;

    dispatch_async(dispatch_get_main_queue(), ^{
        
        if (EvtID == PLAY_EVT_RCV_FIRST_I_FRAME)
        {
            if (!self->_threeDot)
            {
                self->_threeDot = [[FeThreeDotGlow alloc] initWithView:self.view blur:NO];
                [self.view addSubview:self->_threeDot];
                [self->_threeDot showWhileExecutingBlock:^{
                    
                }];
            }
            
        }
        
        if (EvtID == PLAY_EVT_PLAY_BEGIN)
        {
            [self->_threeDot dismiss];
            self->_threeDot.hidden = YES;
//            [self stopLoadingAnimation];
//            long long playDelay = [[NSDate date]timeIntervalSince1970]*1000 - _startPlayTS;
//            AppDemoLog(@"AutoMonitor:PlayFirstRender,cost=%lld", playDelay);
        }
        else if (EvtID == PLAY_EVT_PLAY_PROGRESS)
        {
//            if (_startSeek)
//            {
//                return;
//            }
//            // é¿åæ»å¨è¿åº¦æ¡æ¾å¼çç¬é´å¯è½åºç°æ»å¨æ¡ç¬é´è·³å°ä¸ä¸ä¸ªä½ç½®
//            long long curTs = [[NSDate date]timeIntervalSince1970]*1000;
//            if (llabs(curTs - _trackingTouchTS) < 500)
//            {
//                return;
//            }
//            _trackingTouchTS = curTs;
//
//            float progress = [dict[EVT_PLAY_PROGRESS] floatValue];
//            float duration = [dict[EVT_PLAY_DURATION] floatValue];
//
//            int intProgress = progress + 0.5;
//            _playStart.text = [NSString stringWithFormat:@"%02d:%02d", (int)(intProgress / 60), (int)(intProgress % 60)];
//            [_playProgress setValue:progress];
//
//            int intDuration = duration + 0.5;
//            if (duration > 0 && _playProgress.maximumValue != duration) {
//                [_playProgress setMaximumValue:duration];
//                [_playableProgress setMaximumValue:duration];
//                _playDuration.text = [NSString stringWithFormat:@"%02d:%02d", (int)(intDuration / 60), (int)(intDuration % 60)];
//            }
//
//            [_playableProgress setValue:[dict[EVT_PLAYABLE_DURATION] floatValue]];
            return ;
        }
        else if (EvtID == PLAY_ERR_NET_DISCONNECT || EvtID == PLAY_EVT_PLAY_END)
        {

            __weak __typeof(self) weakSelf = self;
            UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"éè¯ä¸­æ­"
                                                                           message:@"å¯¹æ¹å·²ç»ç»æéè¯"
                                                                    preferredStyle:UIAlertControllerStyleAlert];
            [alert addAction:[UIAlertAction actionWithTitle:@"ç¦»å¼" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action)
            {
            
                [weakSelf.navigationController popToRootViewControllerAnimated:YES];
            }]];
            [alert addAction:[UIAlertAction actionWithTitle:@"åæ¶" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action)
                              
            {
                self.inviteLabel.text = @"è¿æªæäººåä¸è¿æ¥ï¼å¿«æ¥éè¯·Taå§~";
                
                [self updateControlsStatusWith:NO];
                self->isExistGuestLiveStream = NO;
                [self->_threeDot removeFromSuperview];
                self->_threeDot = nil;
                
                [UIView animateWithDuration:1 animations:^{
                    [self updateViewConstraintsWith:NO];
                }];
                self->_liveSessionKey = nil;
                if (self.phoneLivePlayer)
                {
                    [self->_phoneLivePlayer stopPlay];
                    [self->_phoneLivePlayer removeVideoWidget];
                }
                
            }]];
            [weakSelf presentViewController:alert animated:YES completion:nil];
            
        }
        else if (EvtID == PLAY_EVT_PLAY_LOADING)
        {
            self->_threeDot.hidden = NO;
            [self->_threeDot showWhileExecutingBlock:^{
                
            }];
        }
        else if (EvtID == PLAY_EVT_CONNECT_SUCC)
        {
            BOOL isWifi = [AFNetworkReachabilityManager sharedManager].reachableViaWiFi;
            if (!isWifi)
            {
                __weak __typeof(self) weakSelf = self;
                [[AFNetworkReachabilityManager sharedManager] setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
//                    if (_playUrl.length == 0) {
//                        return;
//                    }
                    if (status == AFNetworkReachabilityStatusReachableViaWiFi)
                    {
                        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@""
                                                                                       message:@"æ¨è¦åæ¢å°Wifiåè§çå?"
                                                                                preferredStyle:UIAlertControllerStyleAlert];
                        [alert addAction:[UIAlertAction actionWithTitle:@"æ¯" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
                            [alert dismissViewControllerAnimated:YES completion:nil];
//                            [weakSelf stopRtmp];
//                            [weakSelf startRtmp];
                        }]];
                        [alert addAction:[UIAlertAction actionWithTitle:@"å¦" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
                            [alert dismissViewControllerAnimated:YES completion:nil];
                        }]];
                        [weakSelf presentViewController:alert animated:YES completion:nil];
                    }
                }];
            }
        }else if (EvtID == PLAY_EVT_CHANGE_ROTATION) {
            return;
        }
        NSLog(@"MTLiveConversationViewController evt:%d,%@,EVT_MSG is %@", EvtID, dict,dict[@"EVT_MSG"]);
//        long long time = [(NSNumber*)[dict valueForKey:EVT_TIME] longLongValue];
//        int mil = time % 1000;
//        NSDate* date = [NSDate dateWithTimeIntervalSince1970:time/1000];
//        NSString* Msg = (NSString*)[dict valueForKey:EVT_MSG];
    });
}

-(void) onNetStatus:(NSDictionary*) param
{
    NSDictionary* dict = param;
    
    dispatch_async(dispatch_get_main_queue(), ^{
        int netspeed  = [(NSNumber*)[dict valueForKey:NET_STATUS_NET_SPEED] intValue];
        int vbitrate  = [(NSNumber*)[dict valueForKey:NET_STATUS_VIDEO_BITRATE] intValue];
        int abitrate  = [(NSNumber*)[dict valueForKey:NET_STATUS_AUDIO_BITRATE] intValue];
//        int cachesize = [(NSNumber*)[dict valueForKey:NET_STATUS_CACHE_SIZE] intValue];
//        int dropsize  = [(NSNumber*)[dict valueForKey:NET_STATUS_DROP_SIZE] intValue];
//        int jitter    = [(NSNumber*)[dict valueForKey:NET_STATUS_NET_JITTER] intValue];
        int fps       = [(NSNumber*)[dict valueForKey:NET_STATUS_VIDEO_FPS] intValue];
        int width     = [(NSNumber*)[dict valueForKey:NET_STATUS_VIDEO_WIDTH] intValue];
        int height    = [(NSNumber*)[dict valueForKey:NET_STATUS_VIDEO_HEIGHT] intValue];
//        float cpu_usage = [(NSNumber*)[dict valueForKey:NET_STATUS_CPU_USAGE] floatValue];
//        float cpu_app_usage = [(NSNumber*)[dict valueForKey:NET_STATUS_CPU_USAGE_D] floatValue];
//        NSString *serverIP = [dict valueForKey:NET_STATUS_SERVER_IP];
//        int codecCacheSize = [(NSNumber*)[dict valueForKey:NET_STATUS_CODEC_CACHE] intValue];
//        int nCodecDropCnt = [(NSNumber*)[dict valueForKey:NET_STATUS_CODEC_DROP_CNT] intValue];
//        int nCahcedSize = [(NSNumber*)[dict valueForKey:NET_STATUS_CACHE_SIZE] intValue]/1000;
//        int nSetVideoBitrate = [(NSNumber *) [dict valueForKey:NET_STATUS_SET_VIDEO_BITRATE] intValue];
//        int videoCacheSize = [(NSNumber *) [dict valueForKey:NET_STATUS_VIDEO_CACHE_SIZE] intValue];
//        int vDecCacheSize = [(NSNumber *) [dict valueForKey:NET_STATUS_V_DEC_CACHE_SIZE] intValue];
//        int playInterval = [(NSNumber *) [dict valueForKey:NET_STATUS_AV_PLAY_INTERVAL] intValue];
//        int avRecvInterval = [(NSNumber *) [dict valueForKey:NET_STATUS_AV_RECV_INTERVAL] intValue];
//        float audioPlaySpeed = [(NSNumber *) [dict valueForKey:NET_STATUS_AUDIO_PLAY_SPEED] floatValue];
//        NSString * audioInfo = [dict valueForKey:NET_STATUS_AUDIO_INFO];
//        int videoGop = (int)([(NSNumber *) [dict valueForKey:NET_STATUS_VIDEO_GOP] doubleValue]+0.5f);
//        NSString* log = [NSString stringWithFormat:@"CPU:%.1f%%|%.1f%%\tRES:%d*%d\tSPD:%dkb/s\nJITT:%d\tFPS:%d\tGOP:%ds\tARA:%dkb/s\nQUE:%d|%d,%d,%d|%d,%d,%0.1f\tVRA:%dkb/s\nSVR:%@\tAUDIO:%@",
//                         cpu_app_usage*100,
//                         cpu_usage*100,
//                         width,
//                         height,
//                         netspeed,
//                         jitter,
//                         fps,
//                         videoGop,
//                         abitrate,
//                         codecCacheSize,
//                         cachesize,
//                         videoCacheSize,
//                         vDecCacheSize,
//                         avRecvInterval,
//                         playInterval,
//                         audioPlaySpeed,
//                         vbitrate,
//                         serverIP,
//                         audioInfo];
//        DLog(@"Current status, VideoBitrate:%d, AudioBitrate:%d, FPS:%d, RES:%d*%d, netspeed:%d", vbitrate, abitrate, fps, width, height, netspeed);
    });
}

@end
